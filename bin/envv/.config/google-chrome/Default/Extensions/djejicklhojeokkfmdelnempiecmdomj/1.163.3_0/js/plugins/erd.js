pluginFn['/js/plugins/v2/erd.js'] = function(lucid, window) {
	var g=g||{};g.scope={};g.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};g.ASSUME_ES5=!1;g.ASSUME_NO_NATIVE_MAP=!1;g.ASSUME_NO_NATIVE_SET=!1;
g.defineProperty=g.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};g.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};g.global=g.getGlobal(this);
g.polyfill=function(a,b){if(b){var c=g.global;a=a.split(".");for(var e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&g.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};g.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=g.checkStringArgs(this,a,"startsWith");a+="";var d=b.length,f=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var h=0;h<f&&c<d;)if(b[c++]!=a[h++])return!1;return h>=f}},"es6","es3");
g.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(b.call(c,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}};g.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return g.findInternal(this,a,c).v}},"es6","es3");g.SYMBOL_PREFIX="jscomp_symbol_";g.initSymbol=function(){g.initSymbol=function(){};g.global.Symbol||(g.global.Symbol=g.Symbol)};g.symbolCounter_=0;g.Symbol=function(a){return g.SYMBOL_PREFIX+(a||"")+g.symbolCounter_++};
g.initSymbolIterator=function(){g.initSymbol();var a=g.global.Symbol.iterator;a||(a=g.global.Symbol.iterator=g.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&g.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return g.arrayIterator(this)}});g.initSymbolIterator=function(){}};g.arrayIterator=function(a){var b=0;return g.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
g.iteratorPrototype=function(a){g.initSymbolIterator();a={next:a};a[g.global.Symbol.iterator]=function(){return this};return a};g.makeIterator=function(a){g.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):g.arrayIterator(a)};g.FORCE_POLYFILL_PROMISE=!1;
g.polyfill("Promise",function(a){function b(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(l){b.reject(l)}}function c(){this.batch_=null}function e(a){return a instanceof b?a:new b(function(b){b(a)})}if(a&&!g.FORCE_POLYFILL_PROMISE)return a;c.prototype.asyncExecute=function(a){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(a);return this};c.prototype.asyncExecuteBatch_=function(){var a=
this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var d=g.global.setTimeout;c.prototype.asyncExecuteFunction=function(a){d(a,0)};c.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var d=a[b];delete a[b];try{d()}catch(m){this.asyncThrow_(m)}}}this.batch_=null};c.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};b.prototype.createResolveAndReject_=function(){function a(a){return function(c){d||
(d=!0,a.call(b,c))}}var b=this,d=!1;return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};b.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof b)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var d=null!=a;break a;case "function":d=!0;break a;default:d=!1}d?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};b.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(l){this.reject_(l);
return}"function"==typeof b?this.settleSameAsThenable_(b,a):this.fulfill_(a)};b.prototype.reject_=function(a){this.settle_(2,a)};b.prototype.fulfill_=function(a){this.settle_(1,a)};b.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b|"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};b.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=this.onSettledCallbacks_,
b=0;b<a.length;++b)a[b].call(),a[b]=null;this.onSettledCallbacks_=null}};var f=new c;b.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};b.prototype.settleSameAsThenable_=function(a,b){var d=this.createResolveAndReject_();try{a.call(b,d.resolve,d.reject)}catch(m){d.reject(m)}};b.prototype.then=function(a,d){function c(a,b){return"function"==typeof a?function(b){try{e(a(b))}catch(U){h(U)}}:b}var e,h,f=new b(function(a,b){e=a;h=b});
this.callWhenSettled_(c(a,e),c(d,h));return f};b.prototype.catch=function(a){return this.then(void 0,a)};b.prototype.callWhenSettled_=function(a,b){function d(){switch(c.state_){case 1:a(c.result_);break;case 2:b(c.result_);break;default:throw Error("Unexpected state: "+c.state_);}}var c=this;null==this.onSettledCallbacks_?f.asyncExecute(d):this.onSettledCallbacks_.push(function(){f.asyncExecute(d)})};b.resolve=e;b.reject=function(a){return new b(function(b,d){d(a)})};b.race=function(a){return new b(function(b,
d){for(var c=g.makeIterator(a),f=c.next();!f.done;f=c.next())e(f.value).callWhenSettled_(b,d)})};b.all=function(a){var d=g.makeIterator(a),c=d.next();return c.done?e([]):new b(function(a,b){function f(b){return function(d){h[b]=d;k--;0==k&&a(h)}}var h=[],k=0;do h.push(void 0),k++,e(c.value).callWhenSettled_(f(h.length-1),b),c=d.next();while(!c.done)})};return b},"es6","es3");g.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,c){return g.findInternal(this,a,c).i}},"es6","es3");var n={ERD_ENTITY_BLOCK:"ERDEntityBlock",ERD_ENTITY_BLOCK_2:"ERDEntityBlock2",ERD_ENTITY_BLOCK_3:"ERDEntityBlock3",ERD_ENTITY_BLOCK_4:"ERDEntityBlock4"};
if(!lucid.newEditor)lucid.plugin.onDocumentLoaded(function(){function a(a,b){for(var d=lucid.plugin.getProperty(b[0],a),c=1;c<b.length;c++)if(d!=lucid.plugin.getProperty(b[c],a))return null;return d}function b(b,c){function e(a,b){b||lucid.array.forEach(c.ids,function(b){lucid.plugin.setProperty(b,"Fields",a)})}d&&!c.nospace&&b.spacer();d=!0;"spinner"==c.type?(b.addGrid({width:6,content:{text:c.name+":",classes:"crop ralign"}}),b.openGrid({width:3,suffix:3}),b.addInput({type:"spinner",min:1,max:1E3,
step:1,value:a(c.prop,c.ids),defaultVal:" ",onChange:e}),b.close()):"button"==c.type?(b.openGrid({width:6,prefix:3,suffix:3}),b.addButton({onClick:function(){c.onClick(c.id)},label:c.text}),b.close()):"buttons"==c.type?c.buttons&&2==c.buttons.length&&(b.openGrid({width:12}),b.openGrid({width:6}),b.addButton({onClick:function(){c.buttons[0].onClick(c.id)},label:c.buttons[0].text}),b.close(),b.openGrid({width:6}),b.addButton({onClick:function(){c.buttons[1].onClick(c.id)},label:c.buttons[1].text}),
b.close(),b.close()):"checkbox"==c.type&&(b.addGrid({width:6,content:{text:c.name+":",classes:"crop ralign"}}),b.openGrid({width:6}),b.addInput({type:"buttonset",buttons:lucid.array.realMap([{label:i18n.get("plugin-erd-button-toggle-on"),val:1},{label:i18n.get("plugin-erd-button-toggle-off"),val:0}],function(b){return{label:b.label,value:b.val,selected:function(){return!a(c.prop,c.ids)==!b.val},action:function(){!a(c.prop,c.ids)!=!b.val&&lucid.array.forEach(c.ids,function(a){lucid.plugin.setPropertyIfChanged(a,
c.prop,b.val)})}}})}),b.close())}var c=lucid.template.builder(),e=c.add(),d=!1;lucid.plugin.addCustomPanel("",null,[{content:c}],null,{isContextPanel:!0,checkShow:function(a){a=lucid.array.filter(a,function(a){return a.isBlock});if(!lucid.array.every(a,function(a){return 0==a.className.search("ERD")}))return!1;var f=!1;d=!1;var k=lucid.template.builder(),l={ShadedHeader:{ids:[],name:i18n.get("plugin-erd-menu-shaded-header"),type:"checkbox",prop:"ShadedHeader"},AltRows:{ids:[],name:i18n.get("plugin-erd-menu-alternate-row-color"),
type:"checkbox",prop:"AltRows"},Fields:{ids:[],name:i18n.get("plugin-erd-menu-number-of-fields"),type:"spinner",prop:"Fields"}},m={buttons:[{onClick:p,text:i18n.get("plugin-erd-menu-manage-fields")},{onClick:r.exportSql,text:i18n.get("plugin-erd-menu-export-sql")}],type:"buttons"};classButtons={};lucid.object.forEach(n,function(a){classButtons[a]=m});lucid.array.forEach(a,function(a){lucid.object.forEach(l,function(b){null!=lucid.plugin.getProperty(a.id,b.prop)&&b.ids.push(a.id)})});lucid.object.forEach(l,
function(a){0<a.ids.length&&(b(k,a),f=!0)});if(1==a.length&&classButtons[a[0].className]){var q=classButtons[a[0].className];q.id=a[0].id;b(k,q);f=!0}c.getElement(e).setContent(k);return f},refreshProperties:["Fields"]})});var u={Column:function(a,b,c,e,d,f){this.name=a;this.i=b;this.dataType=c;this.maxCharLength=e;this.index=f;this.table=null;this.primary=d?[]:null;this.foreign=null}};u.Column.prototype.getId=function(){return this.table.getId().concat(this.name)};
u.Column.prototype.getKeyText=function(){var a=[];this.primary&&a.push("PK");this.foreign&&a.push("FK");this.index&&a.push("AK");return a.join(",")};u.Column.prototype.getDataTypeText=function(){return this.dataType+(null!=this.maxCharLength&&0<this.maxCharLength?"("+this.maxCharLength+")":"")};
u.Column.prototype.toProperties=function(a){return void 0==a||0>a?lucid.object.create("Key"+this.i,this.getKeyText(),"Field"+this.i,this.name,"Type"+this.i,this.getDataTypeText()):lucid.object.create("Key"+a,this.getKeyText(),"Field"+a,this.name,"Type"+a,this.getDataTypeText())};u.Column.prototype.setKeyConstraint=function(a){this.foreign=a;lucid.array.insert(a.primary||(a.primary=[]),this)};u.Table=function(a,b,c){this.name=a;this.columns=b;this.blocks=c||[];this.schema=null};
u.Table.prototype.getId=function(){return this.schema.getId().concat(this.name)};u.Table.prototype.getNameText=function(){var a=this.schema.getDisplayName();return(a?a+".":"")+this.name};u.Table.prototype.eachColumn=function(a){lucid.object.forEach(this.columns,a,this)};u.Table.prototype.toProperties=function(){var a={Name:this.getNameText(),TableId:this.getId(),Fields:lucid.object.size(this.columns)},b=1;this.eachColumn(function(c){lucid.object.extend(a,c.toProperties(b));b++});return a};
u.Schema=function(a,b){this.name=a;this.tables=b;this.database=null};u.Schema.prototype.getId=function(){return this.database.getId().concat(this.name)};u.Schema.prototype.getDisplayName=function(){switch(this.database.dbms){case "postgresql":return"public"!=this.name?this.name:"";case "sqlserver":return"dbo"!=this.name?this.name:"";default:return this.name}};u.Schema.prototype.eachTable=function(a){lucid.object.forEach(this.tables,function(b,c){a.call(this,b,c)},this)};
u.Schema.prototype.eachTableSorted=function(a){lucid.object.getKeys(this.tables).sort(lucid.string.caseInsensitiveCompare).forEach(function(b){a.call(this,this.tables[b],b)},this)};u.Schema.prototype.eachColumn=function(a){this.eachTable(function(b){b.eachColumn(a)})};u.Database=function(a,b,c){this.name=a;this.schemas=b;this.dbms=c};u.Database.prototype.getId=function(){return[this.name]};
u.Database.prototype.eachSchema=function(a){lucid.object.forEach(this.schemas,function(b,c){a.call(this,b,c)},this)};u.Database.prototype.eachSchemaSorted=function(a){lucid.object.getKeys(this.schemas).sort(lucid.string.caseInsensitiveCompare).forEach(function(b){a.call(this,this.schemas[b],b)},this)};u.Database.prototype.eachTable=function(a){this.eachSchema(function(b){b.eachTable(a)})};u.Database.prototype.eachColumn=u.Schema.prototype.eachColumn;u.Databases=function(a){this.databases=a};
u.Databases.prototype.eachDatabase=function(a){lucid.object.forEach(this.databases,a,this)};u.Databases.prototype.eachSchema=function(a){this.eachDatabase(function(b){b.eachSchema(a)})};u.Databases.prototype.eachTable=u.Database.prototype.eachTable;u.Databases.prototype.eachColumn=u.Schema.prototype.eachColumn;u.Databases.prototype.getDatabase=function(a){return lucid.object.getValueByKeys(this,"databases",a[0])};
u.Databases.prototype.getSchema=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1])};u.Databases.prototype.getTable=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1],"tables",a[2])};u.Databases.prototype.getColumn=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1],"tables",a[2],"columns",a[3])};
u.Databases.prototype.serialize=function(){return{d:lucid.object.map(this.databases,function(a){return{d:a.dbms,s:lucid.object.map(a.schemas,function(a){return{t:lucid.object.map(a.tables,function(a){return{c:lucid.object.map(a.columns,function(a){return{i:a.i,t:a.dataType,l:a.maxCharLength,p:!!a.primary,f:a.foreign&&a.foreign.getId().slice(1),x:a.index}})}})}})}})}};
u.Databases.deserialize=function(a){a=a||{d:{}};var b=new u.Databases(lucid.object.map(a.d,function(a,b){return new u.Database(b,lucid.object.map(a.s,function(a,c){return new u.Schema(c,lucid.object.map(a.t,function(a,c){return new u.Table(c,lucid.object.map(a.c,function(a,c){c=new u.Column(c,a.i,a.t,a.l,a.p,a.x);c._foreignId=[b].concat(a.f);return c}))}))}),a.d)}));b.eachDatabase(function(a){a.eachSchema(function(c){c.database=a;c.eachTable(function(a){a.schema=c;a.eachColumn(function(c){c.table=
a;if(c._foreignId){var d=b.getColumn(c._foreignId);d&&c.setKeyConstraint(d);delete c._foreignId}})})})});return b};u.getBlocks=function(){return lucid.array.filterMap(lucid.plugin.getAllBlockIds(),function(a){var b;if(lucid.string.startsWith(lucid.plugin.getBlockClassName(a),n.ERD_ENTITY_BLOCK)&&(b=lucid.plugin.getProperty(a,"TableId")))return{id:a,tableId:b}})};
u.getLines=function(){return lucid.array.filterMap(lucid.plugin.getAllLineIds(),function(a){function b(b){var d=lucid.plugin.getProperty(a,b),e;d.Block&&lucid.string.startsWith(d.Style,"CFN ERD")&&(e=lucid.plugin.getProperty(d.Block,"TableId"))&&(e=e.concat(lucid.text.plainText(lucid.plugin.getProperty(d.Block,"Field"+(lucid.array.minIndex(lucid.plugin.getProperty(d.Block,"linkPoints").map(function(a){return Math.abs(a.y-d.LinkY)}))/2-1)))),b={id:a,key:b,blockId:d.Block,columnId:e},lucid.string.contains(d.Style,
"Many")||lucid.string.contains(d.Style,"More")?c.foreign=b:c.primary=b)}var c={id:a};b("Endpoint1");b("Endpoint2");if(c.primary&&c.foreign)return c})};u.Databases.prototype.refreshBlocks=function(){this.eachTable(function(a){a.blocks=[]});var a=[];u.getBlocks().forEach(function(b){var c=this.getTable(b.tableId);c?c.blocks.push(b):a.push(b)},this);return a};
u.Databases.prototype.refreshLines=function(){this.eachColumn(function(a){a.lines=[]});var a=[];u.getLines().forEach(function(b){var c=this.getColumn(b.primary.columnId),e=this.getColumn(b.foreign.columnId);c&&e&&e.foreign==c?e.lines.push(b):a.push(b)},this);return a};
u.Column.prototype.connectBlocks=function(a,b){var c=lucid.plugin.getProperty(a,"BoundingBox"),e=lucid.plugin.getProperty(b,"BoundingBox");1E5<Math.abs(c.x-e.x)||1E5<Math.abs(c.y-e.y)||(e=lucid.array.minIndex([c.x-e.x,c.x-e.x-e.w,c.x+c.w-e.x,c.x+c.w-e.x-e.w].map(Math.abs,Math)),c=lucid.plugin.getProperty(a,"linkPoints")[2*this.i+2+(2<=e)],e=lucid.plugin.getProperty(b,"linkPoints")[2*this.foreign.i+2+e%2],lucid.plugin.addLine(lucid.plugin.getItemPageId(a),{Endpoint1:{Block:b,LinkX:e.x,LinkY:e.y,Style:"CFN ERD One Arrow"},
Endpoint2:{Block:a,LinkX:c.x,LinkY:c.y,Style:"CFN ERD Many Arrow"},Shape:"elbow"}))};
u.Databases.prototype.itemChanges=function(){function a(a,b,c){lucid.object.isEmpty(c)||(a[b]=c)}var b=lucid.array.filterMap(this.refreshBlocks(),function(a){if(this.getDatabase(a.tableId))return a.id},this),c={};this.eachTable(function(b){if(b.blocks.length){var d=b.toProperties();b.blocks.forEach(function(b){a(c,b.id,lucid.object.filter(d,function(a,c){return"Fields"==c?!lucid.object.areEqual(a,lucid.plugin.getProperty(b.id,c)):"TableId"!=c?a!=lucid.text.plainText(lucid.plugin.getProperty(b.id,
c)):!1}))})}},this);var e=lucid.array.filterMap(this.refreshLines(),function(a){if(this.getDatabase(a.primary.columnId)&&this.getDatabase(a.foreign.columnId))return a.id},this),d=[];this.eachColumn(function(a){a.foreign&&a.foreign.table.blocks.length&&a.table.blocks.forEach(function(b){var c=lucid.plugin.getItemPageId(b.id);a.foreign.table.blocks.forEach(function(e){lucid.array.find(a.lines,function(a){return a.foreign.blockId==b.id&&a.primary.blockId==e.id})||c!=lucid.plugin.getItemPageId(e.id)||
d.push({primary:{blockId:e.id,column:a.foreign},foreign:{blockId:b.id,column:a}})})})});var f={};this.eachColumn(function(b){b.lines.forEach(function(c){function d(a,b){var c=lucid.plugin.getProperty(a.id,a.key).LinkY;lucid.array.minIndex(lucid.plugin.getProperty(a.blockId,"linkPoints").map(function(a){return Math.abs(c-a.y)}))/2-1!=b.i&&(e[a.key]=b.i)}var e={};d(c.foreign,b);d(c.primary,b.foreign);a(f,c.id,e)})});return{block:{deletes:b,updates:c},line:{adds:d,deletes:e,updates:f}}};
u.Databases.prototype.countItemChanges=function(){var a=this.itemChanges();return{block:{deletes:a.block.deletes.length,updates:lucid.object.size(a.block.updates)},line:{adds:a.line.adds.length,deletes:a.line.deletes.length,updates:lucid.object.size(a.line.updates)}}};
u.Databases.prototype.doItemChanges=function(){var a=this.itemChanges();a.block.deletes.forEach(lucid.plugin.deleteItem);lucid.object.forEach(a.block.updates,function(a,c){lucid.object.forEach(a,function(a,b){"Fields"==b?lucid.plugin.setPropertyIfChanged(c,b,a):lucid.plugin.setText(c,b,a)})});a.line.adds.forEach(function(a){a.foreign.column.connectBlocks(a.foreign.blockId,a.primary.blockId)});a.line.deletes.forEach(lucid.plugin.deleteItem);lucid.object.forEach(a.line.updates,function(a,c){var b=lucid.plugin.getProperty(c,
"linkPoints");lucid.object.forEach(a,function(a,e){var d=lucid.plugin.getProperty(c,e);d.LinkY=b[2*a].y;lucid.plugin.setPropertyIfChanged(c,e,d)})})};var v=[{separator:"\t",delimiter:"\x00"},{separator:","},{separator:";"}];
function x(a,b,c,e){try{return lucid.CSV.toArrays(a,v[b],function(d){if(d&&d.length&&1<d[0].length){c&&e.close();"dbms"==d[0][0].toLowerCase()&&(d=d.slice(1));var f=u.dbms[d[0][0]],h=f.fields,k=f.convert(d.map(function(a){var b={};a.forEach(function(a,c){c&&(b[h[c-1]]={NULL:!0,"null":!0,"":!0,"-":!0,"\\N":!0}[a]?null:a)});return b})),l=u.document.getData()||{d:{}};lucid.object.extend(l.d,k.d);d=u.Databases.deserialize(l).countItemChanges();f=[];d.block.updates&&f.push(i18n.get("plugin-erd-change-text-shape-update",
{count:d.block.updates}));d.block.deletes&&f.push(i18n.get("plugin-erd-change-text-shape-delete",{count:d.block.deletes}));d.line.adds&&f.push(i18n.get("plugin-erd-change-text-line-add",{count:d.line.adds}));d.line.updates&&f.push(i18n.get("plugin-erd-change-text-line-update",{count:d.line.updates}));d.line.deletes&&f.push(i18n.get("plugin-erd-change-text-line-delete",{count:d.line.deletes}));var m=function(){lucid.plugin.setPropertyIfChanged(null,"HiddenToolGroups",lucid.object.filter(lucid.plugin.getProperty(null,
"HiddenToolGroups"),function(a,b){return!(b.startsWith("erd.jsâ˜ºerd.")&&k.d[b.substring(11)])}));u.document.setData(l)};if(f.length){var q=lucid.dialog.custom({children:[i18n.get("plugin-erd-change-header-text"),{tag:"br"},{tag:"ul",children:f.map(function(a){return{tag:"li",text:a}})}]},{title:i18n.get("plugin-erd-change-title"),modal:!0,closeButton:!0,buttons:[{label:i18n.get("plugin-erd-change-button-yes"),action:function(){q.destroy();m();u.databases.doItemChanges()}},{label:i18n.get("plugin-erd-change-button-no"),
action:function(){m();q.destroy()}}]});q.open()}else m();lucid.kissMetrics.record(lucid.kissMetrics.Events.importedERD);return!0}if(b+1<v.length)return x(a,b+1,c,e);lucid.dialog.alert(i18n.get("plugin-erd-change-error-message"));return!1})}catch(d){return lucid.dialog.alert(i18n.get("plugin-erd-change-error-message")),!1}}u.toolbox={};u.toolbox.groups=[];
u.toolbox.erdGroups=[n.ERD_ENTITY_BLOCK,n.ERD_ENTITY_BLOCK_2,n.ERD_ENTITY_BLOCK_3,n.ERD_ENTITY_BLOCK_4,{label:i18n.get("plugin-erd-toolbox-button-import"),action:function(){lucid.log.analytics("erd.auto.import");var a=lucid.template.builder();a.add({tag:"p",html:i18n.get("plugin-erd-import-label",{},["<a target='_blank' href='http://support.lucidchart.com/anonymous_requests/new'>{}</a>"])});a.add({tag:"label",text:i18n.get("plugin-erd-import-choose-dbms")});a.addInput({type:"radio",separator:'<span style="margin-left:6px"/>',
buttons:[{label:i18n.get("plugin-erd-import-dbms-mysql"),value:"mysql"},{label:i18n.get("plugin-erd-import-dbms-oracle"),value:"oracle"},{label:i18n.get("plugin-erd-import-dbms-postresql"),value:"postgresql"},{label:i18n.get("plugin-erd-import-dbms-sqlserver"),value:"sqlserver"}],onChange:function(c){c=u.dbms[c].query.trim().replace(/\s+/g," ").replace(/\s([,;)(=])/g,"$1").replace(/([,;)(=])\s/g,"$1");a.getElement(b).text(c)}});a.spacer();a.add({tag:"label",text:i18n.get("plugin-erd-import-run-query")});
a.add({css:{height:"3px"}});var b=a.add({id:"queryTextArea",tag:"textarea",attr:{rows:"8",readonly:"readonly"},css:{display:"block","font-size":"10px",width:"376px",height:"150px",resize:"none"}});a.spacer();a.add({tag:"label",text:i18n.get("plugin-erd-import-import-file")});a.addInput({type:"file",onSuccess:function(a){lucid.log.analytics("erd.auto.import.file");x(a,0,!0,c)}});a.spacer();a.add({tag:"label",text:i18n.get("plugin-erd-import-paste-results")});a.add({css:{height:"3px"}});var c=lucid.dialog.textAreaPrompt(a.getTemplate(),
null,function(a){lucid.log.analytics("erd.auto.import.paste");x(a,0,void 0,c)},null,{height:"200px"},i18n.get("plugin-erd-import-title"))}},{label:i18n.get("plugin-erd-toolbox-button-export"),action:function(){r.exportSql()}}];
u.toolbox.add=function(){var a={"Entity Relationship":{displayName:i18n.get("plugin-erd-plugin-name"),items:u.toolbox.erdGroups}};if(u.databases){var b=lucid.plugin.getToolGroupOrder("Entity Relationship"),c=[];u.databases.eachDatabase(function(b,d){b.eachSchemaSorted(function(b){var e="erd."+d,f=b.getDisplayName();a[e]||(a[e]=[]);f&&a[e].push({template:{text:f,css:{"font-weight":"bold","font-style":"italic"}}});b.eachTableSorted(function(b,c){function d(a){return lucid.text.measure(lucid.array.maxElement(m.map(a),
function(a){return a.length})).w}function f(){return d(function(a){return a.getKeyText()||"PK"})+20}function k(){return d(function(a){return a.name})+20}function h(){return d(function(a){return a.getDataTypeText()})+20}var l=b.getNameText(),m=lucid.object.getValues(b.columns);a[e].push({category:e,className:n.ERD_ENTITY_BLOCK_4,name:l,tooltip:c,helperText:c,noBlockPrompt:!0,defaultProperties:function(){var a=b.toProperties();a.Column1=f();a.Column2=h();return a},defaultSize:function(){return{w:Math.max(160,
f()+k()+h(),lucid.text.measure(l).w+20),h:42.5+28*lucid.object.size(b.columns)}}})});b="erd."+d;u.toolbox.groups.push(b);lucid.plugin.setToolGroupOptions(b,{displayName:d,menuItems:[{label:i18n.get("plugin-erd-toolbox-remove"),action:function(){delete u.databases.databases[d];u.document.setData(u.databases.serialize())}}]});-1==lucid.plugin.getToolGroupOrder(b)&&c.push(b)})});lucid.plugin.createToolGroups(a);0<c.length&&lucid.plugin.setToolGroupsOrder(c,b)}else lucid.plugin.createToolGroups(a)};
u.document={};u.document.KEY="ERDData";u.document.getData=function(){return lucid.plugin.getProperty(null,u.document.KEY)};u.document.setData=function(a){lucid.plugin.setPropertyIfChanged(null,u.document.KEY,a)};u.databases=null;var y=!1;lucid.plugin.onDocumentLoaded(function(){y=!0;var a=u.document.getData();lucid.plugin.registerProperty(null,u.document.KEY,a,null,function(a,c){u.databases=u.Databases.deserialize(c);u.toolbox.add()})});u.dbms={};
u.dbms.mysql={fields:"tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedTableSchema referencedTableName referencedColumnName".split(" "),query:"SELECT 'mysql' dbms, t.TABLE_SCHEMA, t.TABLE_NAME, c.COLUMN_NAME, c.ORDINAL_POSITION, c.DATA_TYPE, c.CHARACTER_MAXIMUM_LENGTH, n.CONSTRAINT_TYPE, k.REFERENCED_TABLE_SCHEMA, k.REFERENCED_TABLE_NAME, k.REFERENCED_COLUMN_NAME FROM INFORMATION_SCHEMA.TABLES t LEFT JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_SCHEMA = c.TABLE_SCHEMA AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE k ON c.TABLE_SCHEMA = k.TABLE_SCHEMA AND c.TABLE_NAME = k.TABLE_NAME AND c.COLUMN_NAME = k.COLUMN_NAME LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS n ON k.CONSTRAINT_SCHEMA = n.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = n.CONSTRAINT_NAME AND k.TABLE_SCHEMA = n.TABLE_SCHEMA AND k.TABLE_NAME = n.TABLE_NAME WHERE t.TABLE_TYPE = 'BASE TABLE' AND t.TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'mysql');",
convert:function(a){var b={d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableSchema,{d:"mysql",s:{}}).s,"",{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumnName&&["",a.referencedTableName,
a.referencedColumnName],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};
u.dbms.oracle={fields:"databaseName owner tableName columnName columnId dataType dataLength constraintType referencedOwner referencedTable referencedColumn".split(" "),query:"SELECT 'oracle' dbms, ORA_DATABASE_NAME, t.OWNER, t.TABLE_NAME, c.COLUMN_NAME, c.COLUMN_ID, c.DATA_TYPE, c.DATA_LENGTH, n.CONSTRAINT_TYPE, r.OWNER , r.TABLE_NAME , r.COLUMN_NAME FROM ALL_TABLES t LEFT JOIN ALL_TAB_COLS c ON t.OWNER = c.OWNER AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN ALL_CONS_COLUMNS nc ON c.OWNER = nc.OWNER AND c.TABLE_NAME = nc.TABLE_NAME AND c.COLUMN_NAME = nc.COLUMN_NAME LEFT JOIN ALL_CONSTRAINTS n ON nc.OWNER = n.OWNER AND nc.CONSTRAINT_NAME = n.CONSTRAINT_NAME AND n.CONSTRAINT_TYPE IN ('P', 'U', 'R') LEFT JOIN ALL_CONS_COLUMNS r ON n.R_OWNER = r.OWNER AND n.R_CONSTRAINT_NAME = r.CONSTRAINT_NAME AND nc.POSITION = r.POSITION WHERE c.COLUMN_NAME IS NOT NULL;",convert:function(a){var b=
{d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.databaseName||"Oracle",{d:"oracle",s:{}}).s,a.owner||"",{t:{}}).t,a.tableName,{c:{}});c=lucid.object.setIfUndefined(c.c,a.columnName,{});c.i=parseInt(a.columnId,10);c.t=a.dataType.toLowerCase();c.l=a.dataLength&&"number"!=c.t?parseInt(a.dataLength,10):null;c.p=c.p||"P"==a.constraintType;c.f=c.f||a.referencedOwner&&[a.referencedOwner,a.referencedTable,a.referencedColumn];c.x=
c.x||"U"==a.constraintType});return b}};
u.dbms.postgresql={fields:"tableCatalog tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedSchema referencedTable referencedColumn".split(" "),query:"SELECT 'postgresql' AS dbms, t.table_catalog, t.table_schema, t.table_name, c.column_name, c.ordinal_position, c.data_type, c.character_maximum_length, n.constraint_type, k2.table_schema, k2.table_name, k2.column_name FROM information_schema.tables t NATURAL LEFT JOIN information_schema.columns c LEFT JOIN (information_schema.key_column_usage k NATURAL JOIN information_schema.table_constraints n NATURAL LEFT JOIN information_schema.referential_constraints r)ON c.table_catalog = k.table_catalog AND c.table_schema = k.table_schema AND c.table_name = k.table_name AND c.column_name = k.column_name LEFT JOIN information_schema.key_column_usage k2 ON k.position_in_unique_constraint = k2.ordinal_position AND r.unique_constraint_catalog = k2.constraint_catalog AND r.unique_constraint_schema = k2.constraint_schema AND r.unique_constraint_name = k2.constraint_name WHERE t.TABLE_TYPE = 'BASE TABLE' AND t.table_schema NOT IN ('information_schema', 'pg_catalog');",convert:function(a){var b=
{d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableCatalog,{d:"postgresql",s:{}}).s,a.tableSchema,{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumn&&[a.referencedSchema,a.referencedTable,
a.referencedColumn],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};
u.dbms.sqlserver={fields:"tableCatalog tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedSchema referencedTable referencedColumn".split(" "),query:"SELECT 'sqlserver' dbms, t.TABLE_CATALOG, t.TABLE_SCHEMA, t.TABLE_NAME, c.COLUMN_NAME, c.ORDINAL_POSITION, c.DATA_TYPE, c.CHARACTER_MAXIMUM_LENGTH, n.CONSTRAINT_TYPE, k2.TABLE_SCHEMA, k2.TABLE_NAME, k2.COLUMN_NAME FROM INFORMATION_SCHEMA.TABLES t LEFT JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_CATALOG = c.TABLE_CATALOG AND t.TABLE_SCHEMA = c.TABLE_SCHEMA AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN (INFORMATION_SCHEMA.KEY_COLUMN_USAGE k JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS n ON k.CONSTRAINT_CATALOG = n.CONSTRAINT_CATALOG AND k.CONSTRAINT_SCHEMA = n.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = n.CONSTRAINT_NAME LEFT JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS r ON k.CONSTRAINT_CATALOG = r.CONSTRAINT_CATALOG AND k.CONSTRAINT_SCHEMA = r.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = r.CONSTRAINT_NAME)ON c.TABLE_CATALOG = k.TABLE_CATALOG AND c.TABLE_SCHEMA = k.TABLE_SCHEMA AND c.TABLE_NAME = k.TABLE_NAME AND c.COLUMN_NAME = k.COLUMN_NAME LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE k2 ON k.ORDINAL_POSITION = k2.ORDINAL_POSITION AND r.UNIQUE_CONSTRAINT_CATALOG = k2.CONSTRAINT_CATALOG AND r.UNIQUE_CONSTRAINT_SCHEMA = k2.CONSTRAINT_SCHEMA AND r.UNIQUE_CONSTRAINT_NAME = k2.CONSTRAINT_NAME WHERE t.TABLE_TYPE = 'BASE TABLE';",convert:function(a){var b=
{d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableCatalog,{d:"sqlserver",s:{}}).s,a.tableSchema,{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumn&&[a.referencedSchema,a.referencedTable,
a.referencedColumn],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};var A={};
lucid.plugin.onDocumentLoaded(function(){void 0===lucid.plugin.getProperty(null,"erd-v2")&&lucid.text.awaitMetrics().then(function(){lucid.plugin.withSilentActions(function(){lucid.plugin.getAllBlockIds().filter(function(a){return lucid.string.startsWith(lucid.plugin.getBlockClassName(a),n.ERD_ENTITY_BLOCK)}).forEach(function(a){function b(b,c){var d=lucid.text.getSize(a,b),e=d&&d.h+10||c;e=Math.round(Math.max(c,e));lucid.plugin.setProperty(a,b+"_h",e);d&&(d.h/=1.2);return Math.round(Math.max(c,d&&
d.h+10||c))}function c(b,c){var f=lucid.plugin.getProperty(b,c);if(f&&f.Block==a){var k=f.LinkX;f=f.LinkY;for(var h=0,l=0;l<d.length;l++)Math.abs(d[l]/e-f)<Math.abs(d[h]/e-f)&&(h=l);(.01>k||.99<k)&&m.push({lineId:b,prop:c,field:h})}}var e=0,d=[],f=b("Name",40);d.push(e+f/2);e+=f;f=lucid.plugin.getProperty(a,"fieldNames",!0);for(var h=lucid.plugin.getProperty(a,"Fields"),k=1;k<=h;k++){var l=0;f.forEach(function(a){l=Math.max(l,b(a+k,20))});d.push(e+l/2);e+=l}var m=[];lucid.array.forEach(lucid.plugin.getConnectedLines(a),
function(a){c(a,"Endpoint1");c(a,"Endpoint2")});A[a](m)});lucid.plugin.setProperty(null,"erd-v2",!0)})})});lucid.plugin.onDocumentLoaded(function(){u.document.getData()&&lucid.kissMetrics.record(lucid.kissMetrics.Events.viewedImportedERD)});var B=!1;lucid.plugin.beforeCurrentUserNewAction(function(){B=!0});lucid.plugin.afterCurrentUserNewAction(function(){B=!1});
function C(a,b,c){c=c||{};var e=b.map(function(a){return a.name});lucid.plugin.registerAdvancedAction(a,"addFieldAbove",function(){var a=D();a&&E(a)},F);lucid.plugin.registerAdvancedAction(a,"addFieldBelow",function(){var a=D();a&&E(a,!0)},F);lucid.plugin.registerAdvancedAction(a,"deleteField",function(){var a=D();a&&G(a)},H);lucid.plugin.registerAdvancedAction(a,"exportSql",function(){var a=D();a&&r.exportSql(a)},function(){return!!D()});lucid.plugin.registerAdvancedAction("AnySelection","tryParseCsv",
function(a){return x(a,0)},function(){return!!D()});lucid.plugin.initBlockClass({className:a,name:i18n.get("plugin-erd-toolbox-entity-name"),searchKeywords:i18n.get("plugin-erd-search-keywords"),defaultSize:{w:200,h:120},vLock:!0,showLinkPoints:!0,disableEdgeResize:!0,onInit:function(a){function c(){if(!lucid.plugin.isSample(a)){var b=lucid.plugin.getProperty(a,"Fields");if(null!==b){b=m(b)+I(a,b);var c=lucid.plugin.getProperty(a,"BoundingBox");c.h!=b&&(c.h=b,lucid.plugin.setProperty(a,"BoundingBox",
c))}}}function d(){t=t||Promise.resolve().then(function(){t=null;c()});k()}function k(){z++;Promise.resolve().then(function(){z--;if(0==z){var b=lucid.plugin.getProperty(a,"pendingReconnect",!0);b&&(J(a,b[0],b[1]),lucid.plugin.setProperty(a,"pendingReconnect",null,!0))}})}function l(b,c){var e=null;w[b]=function(){if(B){var f=y;e=e||lucid.text.awaitMetrics().then(function(){e=null;if((f||void 0===lucid.plugin.getProperty(a,b+"_h"))&&void 0!==lucid.plugin.getProperty(null,"erd-v2")){null==lucid.plugin.getProperty(a,
"pendingReconnect",!0)&&lucid.plugin.setProperty(a,"pendingReconnect",[K(a)],!0);var k=lucid.text.getSize(a,b);k=k&&k.h+10||c;k=Math.round(Math.max(c,k));k!=lucid.plugin.getProperty(a,b+"_h")&&(lucid.plugin.setPropertyIfChanged(a,b+"_h",k),d())}});k()}};lucid.plugin.hookPropertyPostSave(a,b,w[b]);lucid.plugin.hookPropertyPostSave(a,"Column1",w[b]);lucid.plugin.hookPropertyPostSave(a,"Column2",w[b])}function m(b){if(0>=b)return 0;var c=lucid.plugin.getNonEphemeralObjectProperties(a),d=c.get("Name_h");
if(1<b)for(var e=lucid.plugin.getProperty(a,"fieldNames",!0),f=1;f<b;f++){for(var k=0,h=0;h<e.length;h++)k=Math.max(k,c.get(e[h]+f+"_h")||28);d+=k}return d}function q(c,d){var e=b[c].name,f=lucid.text.getStyle(a,e+(d-1));void 0===lucid.plugin.getProperty(a,e+d+"_h")&&lucid.plugin.setProperty(a,e+d+"_h",lucid.plugin.getProperty(null,"erd-v2")?32:28);var k=L(e);lucid.plugin.addBlockTextArea(a,{id:e+d,value:f?lucid.text.restyle(k,f):k,getBoundingBox:function(e){function f(c){return 0==c?0:c==b.length?
e.w:b[c].x(function(b){return lucid.plugin.getProperty(a,b)})}if(d>lucid.plugin.getProperty(a,"Fields"))return null;var k=f(c)+5,h=f(c+1)-5,l=m(d)+2.5,q=I(a,d)-5;return{x:e.x+k,y:e.y+l,w:h-k,h:q}},onFocus:function(){lucid.plugin.setProperty(a,"selectedRow",d,!0)},align:b[c].align});l(e+d,20)}if(""!=a){lucid.plugin.setProperty(a,"DisableAutoLink",!0);lucid.plugin.registerProperty(a,"AltRows",0);lucid.plugin.registerProperty(a,"ShadedHeader",0);lucid.plugin.registerProperty(a,"Name_h",40);lucid.plugin.addBlockTextArea(a,
{id:"Name",value:i18n.get("plugin-erd-default-text-entity"),getBoundingBox:function(b){return{x:b.x+10,y:b.y,w:b.w-20,h:lucid.plugin.getProperty(a,"Name_h")}},onFocus:function(){lucid.plugin.setProperty(a,"selectedRow",null,!0)}});var t=null,z=0;lucid.plugin.hookPropertyPostSave(a,"pendingReconnect",function(a,b){null!=b&&k()});y||(A[a]=function(b){c();J(a,b);lucid.plugin.setProperty(a,"pendingReconnect",null,!0)});var w={};l("Name",40);lucid.plugin.registerProperty(a,"Fields",3,function(b){B&&null==
lucid.plugin.getProperty(a,"pendingReconnect",!0)&&lucid.plugin.setProperty(a,"pendingReconnect",[K(a)],!0);return b},function(c,e){lucid.plugin.getProperty(a,"selectedRow",!0)>e&&lucid.plugin.setProperty(a,"selectedRow",void 0,!0);c=lucid.plugin.getBlockTextAreas(a);for(var f=b.length,k=1;k<=e;k++)for(var h=0;h<f;h++){var l=b[h].name;if(!lucid.array.contains(c,l+k))q(h,k);else if(void 0===lucid.plugin.getProperty(a,l+k+"_h"))w[l+k]()}void 0!==lucid.plugin.getProperty(null,"erd-v2")&&d()});lucid.plugin.registerProxyProperty(a,
"FieldData",function(){for(var b=lucid.plugin.getAllProperties(a),c=[],d=0;d<b.Fields;d++)c.push(lucid.array.toObjectKeys(e,function(a){return lucid.text.plainText(b[a+(d+1)])}));return c},function(b){var c=["Key","Field","Type"];lucid.plugin.setPropertyIfChanged(a,"Fields",b.length);b.forEach(function(b,d){lucid.object.forEach(b,function(b,e){lucid.array.contains(c,e)&&lucid.plugin.setPropertyIfChanged(a,e+(d+1),lucid.text.restyle(b,{}))})})});lucid.plugin.registerProxyProperty(a,"linkPoints",function(){for(var b=
lucid.plugin.getProperty(a,"Fields"),c=lucid.plugin.getProperty(a,"BoundingBox"),d=[{x:.5,y:0},{x:.5,y:1}],e=0,f=0;f<=b;f++){var k=I(a,f),h=(e+k/2)/c.h;d.push({x:0,y:h});d.push({x:1,y:h});e+=k}return d});lucid.plugin.hookPropertyPostSave(a,"Fields",function(){lucid.plugin.proxyPropertyChanged(a,"FieldData")});lucid.plugin.setProperty(a,"fieldNames",e,!0)}},onCreate:function(a){u.databases.refreshBlocks();var b=lucid.plugin.getProperty(a,"TableId"),c;if(b&&(c=u.databases.getTable(b))){lucid.kissMetrics.record(lucid.kissMetrics.Events.addedImportedERDTableToDiagram);
var d=lucid.plugin.getItemPageId(a);lucid.object.forEach(c.columns,function(b){b.foreign&&b.foreign.table.blocks.forEach(function(c){d==lucid.plugin.getItemPageId(c.id)&&b.connectBlocks(a,c.id)});b.primary&&b.primary.forEach(function(c){b.table!=c.table&&c.table.blocks.forEach(function(b){d==lucid.plugin.getItemPageId(b.id)&&c.connectBlocks(b.id,a)})})})}},onDelete:function(a){lucid.plugin.getConnectedLines(a).map(lucid.plugin.deleteItem)},lineDrawnProperties:function(){return{Endpoint1:{Style:"CFN ERD One Arrow"},
Endpoint2:{Style:"CFN ERD Many Arrow"},Shape:"elbow"}},getLinkPoints:function(a){return lucid.plugin.getProperty(a,"linkPoints")||[]},getRenderData:function(a,e,h){var d=a.BoundingBox,f=[];f.push({FillColor:a.FillColor,Actions:[{Action:"move",x:d.x,y:d.y},{Action:"line",x:d.x+d.w,y:d.y},{Action:"line",x:d.x+d.w,y:d.y+d.h},{Action:"line",x:d.x,y:d.y+d.h},{Action:"close"}]});if(a.AltRows)for(var m=0,q=I(h,0),t=0;t<=a.Fields;t++){var z=I(h,t);0==t%2&&0!=t&&(q=t<a.Fields?m+z:d.h,f.push({FillColor:lucid.color.darken(a.FillColor,
.1),NoRounding:!0,Actions:[{Action:"move",x:d.x,y:d.y+m},{Action:"line",x:d.x+d.w,y:d.y+m},{Action:"line",x:d.x+d.w,y:d.y+q},{Action:"line",x:d.x,y:d.y+q},{Action:"close"}]}));m+=z}a.ShadedHeader&&(m=a.Name_h,f.push({FillColor:lucid.color.darken(a.FillColor,.2),NoRounding:!0,Actions:[{Action:"move",x:d.x,y:d.y},{Action:"line",x:d.x+d.w,y:d.y},{Action:"line",x:d.x+d.w,y:d.y+m},{Action:"line",x:d.x,y:d.y+m},{Action:"close"}]}));f.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,Actions:[{Action:"move",
x:d.x,y:d.y},{Action:"line",x:d.x+d.w,y:d.y},{Action:"line",x:d.x+d.w,y:d.y+d.h},{Action:"line",x:d.x,y:d.y+d.h},{Action:"close"}]});var w=d.y+("sample"==e?d.h/4:a.Name_h);f.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,Actions:[{Action:"move",x:d.x,y:w},{Action:"line",x:d.x+d.w,y:w}]});b.forEach(function(b,h){h&&(b=b.x(function(b){return b in a?a[b]:"sample"==e&&c.sampleProperties&&b in c.sampleProperties?c.sampleProperties[b]*d.w:void 0})+d.x,f.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,
Actions:[{Action:"move",x:b,y:w},{Action:"line",x:b,y:d.y+d.h}]}))});a.selectedRow&&"pdf"!=e&&(h=M(h),m=h[a.selectedRow],f.push({StrokeColor:"#29aae1",LineWidth:2,NoRounding:!0,Actions:[{Action:"move",x:m.x+a.LineWidth/2,y:m.y},{Action:"line",x:m.x+m.w-a.LineWidth/2,y:m.y},{Action:"line",x:m.x+m.w-a.LineWidth/2,y:m.y+m.h},{Action:"line",x:m.x+a.LineWidth/2,y:m.y+m.h},{Action:"close"}]}),a.potentialSwitchRow&&(h=h[a.potentialSwitchRow],f.push({StrokeColor:"#29aae1",LineWidth:5,NoRounding:!0,Actions:[{Action:"move",
x:h.x+a.LineWidth/2,y:h.y+(a.potentialSwitchRow<a.selectedRow?0:h.h)},{Action:"line",x:h.x+h.w-a.LineWidth/2,y:h.y+(a.potentialSwitchRow<a.selectedRow?0:h.h)}]})));return f},getOffsetProperties:c.onWidthChange&&function(a){var b=lucid.plugin.defaultOffsetProperties.apply(null,arguments),d=lucid.object.getValueByKeys(b,a,"BoundingBox");d&&lucid.object.extend(b[a],c.onWidthChange(a,d.w));return b},hitTest:function(a,b){var c=lucid.plugin.getSelection();if(1===c.length&&c[0]==a&&!lucid.plugin.getProperty(a,
"Lock")){var d=lucid.plugin.getProperty(a,"Rotation");c=lucid.plugin.getProperty(a,"BoundingBox");b=lucid.math.Point.rotate(b,lucid.math.Box.center(c),-d);lucid.plugin.getProperty(a,"FlipY")&&(b=lucid.math.Point.rotate(b,lucid.math.Box.center(c),Math.PI));var e=N(a,b);if(0<e)return{onClick:function(){O?lucid.plugin.setProperty(a,"selectedRow",e,!0):O=!0}};if(0===e)return{onClick:function(){O=!0;lucid.plugin.setProperty(a,"selectedRow",null,!0)}}}},preferredTextArea:function(a){if((a=lucid.plugin.getProperty(a,
"selectedRow",!0))&&e.length)return e[0]+a},spatialControls:function(a){var c=[],d=lucid.plugin.getProperty(a,"BoundingBox"),e=d.y+lucid.plugin.getProperty(a,"Name_h"),l=lucid.array.filterMap(b,function(b){if(b.spatialControl){var f=c.length,h=d.x+b.x(function(b){return lucid.plugin.getProperty(a,b)});c.push(h);return{location:function(){return{x:h-5,y:e-5,w:10,h:10}},moved:function(c){b.spatialControl(a,c.x-d.x)},path:function(){return[{x:lucid.object.get(c,f-1,d.x)+4,y:e},{x:lucid.object.get(c,
f+1,d.x+d.w)-4,y:e}]}}}}),m=lucid.plugin.getProperty(a,"selectedRow",!0);if(m){var q=M(a),t=q[m];t&&l.push({location:function(){return t},moved:function(b,c){b=N(a,b);0<b&&b!==m?c?(lucid.plugin.setProperty(a,"potentialSwitchRow",null,!0),P(a,m,b),lucid.plugin.setProperty(a,"selectedRow",b,!0)):lucid.plugin.setProperty(a,"potentialSwitchRow",b,!0):lucid.plugin.setProperty(a,"potentialSwitchRow",null,!0)},path:function(){var a=lucid.math.Box.combine(q.slice(1));return[lucid.math.Box.getRelativePoint(a,
.5,0),lucid.math.Box.getRelativePoint(a,.5,1)]},color:"none"})}return l}});lucid.plugin.registerToggleControl(a,"ShadedHeader");lucid.plugin.registerToggleControl(a,"AltRows");lucid.plugin.registerStepperControl(a,"Fields",function(){return 1},function(){return 1},function(){return 1E3});lucid.plugin.registerCustomControl(a,"FieldData");lucid.plugin.onSelectionChange(function(){O=!1;lucid.plugin.getDescendants(lucid.plugin.getActivePageId()).forEach(function(b){lucid.plugin.getBlockClassName(b)==
a&&lucid.plugin.setProperty(b,"selectedRow",null,!0)})})}var O=!1;
lucid.plugin.addContextMenuItems([{external:!0,label:i18n.get("plugin-erd-contextmenu-insert-row-above"),logAction:"plugin.erd.contextMenu.addRow.above",action:function(){var a=D();a&&E(a)},visible:F},{external:!0,label:i18n.get("plugin-erd-contextmenu-insert-row-below"),logAction:"plugin.erd.contextMenu.addRow.below",action:function(){var a=D();a&&E(a,!0)},visible:F},{external:!0,label:i18n.get("plugin-erd-contextmenu-delete-row"),logAction:"plugin.erd.contextMenu.deleteRow",action:function(){var a=
D();a&&G(a)},visible:H}]);function L(a){return"Field"===a?i18n.get("plugin-erd-default-text-field"):"Type"===a?i18n.get("plugin-erd-default-text-type"):"Key"===a?i18n.get("plugin-erd-default-text-key"):a}function I(a,b){var c=lucid.plugin.getProperty(a,"fieldNames",!0);if(0==b)return lucid.plugin.getProperty(a,"Name_h");a=lucid.plugin.getNonEphemeralObjectProperties(a);for(var e=0,d=0;d<c.length;d++)e=Math.max(e,a.get(c[d]+b+"_h")||28);return e}
function F(){var a=D();return a?!!lucid.plugin.getProperty(a,"selectedRow",!0)&&1E3>lucid.plugin.getProperty(a,"Fields"):!1}function H(){var a=D();return a?!!lucid.plugin.getProperty(a,"selectedRow",!0)&&1<lucid.plugin.getProperty(a,"Fields"):!1}
function P(a,b,c){if(b!==c){var e=lucid.plugin.getProperty(a,"Fields"),d=lucid.plugin.getProperty(a,"fieldNames",!0),f=K(a);d.forEach(function(d){var e=lucid.plugin.getProperty(a,d+b);if(b<c)for(var f=b;f<c;f++)lucid.plugin.setProperty(a,d+f,lucid.plugin.getProperty(a,d+(f+1)));else if(b>c)for(f=b;f>c;f--)lucid.plugin.setProperty(a,d+f,lucid.plugin.getProperty(a,d+(f-1)));lucid.plugin.setProperty(a,d+c,e)});e=Q(e,b,c);lucid.plugin.setProperty(a,"pendingReconnect",[f,e],!0)}}
function Q(a,b,c){for(var e={},d=1;d<=a;d++)b<=d&&d<c?e[d+1]=d:c<d&&d<=b?e[d-1]=d:d===c?e[b]=d:e[d]=d;return e}
function E(a,b){var c=lucid.plugin.getProperty(a,"selectedRow",!0);if(c){var e=b?c+1:c;b=lucid.plugin.getProperty(a,"Fields");var d=b+1;c=lucid.plugin.getProperty(a,"fieldNames",!0);var f=K(a);c.forEach(function(b){for(var c=d;0<c;c--)c>e?lucid.plugin.setProperty(a,b+c,lucid.plugin.getProperty(a,b+(c-1))):c===e&&lucid.plugin.setProperty(a,b+c,b)});for(var h={},k=1;k<=b;k++)h[k]=k<e?k:k+1;lucid.plugin.setProperty(a,"Fields",d);lucid.plugin.setProperty(a,"pendingReconnect",[f,h],!0);lucid.plugin.setPropertyIfChanged(a,
"selectedRow",e,!0);lucid.text.isEditorActive()&&lucid.plugin.editBlockTextArea(a,c[0]+e)}}
function G(a){var b=lucid.plugin.getProperty(a,"selectedRow",!0);if(b){var c=lucid.plugin.getProperty(a,"Fields"),e=lucid.plugin.getProperty(a,"fieldNames",!0),d=K(a);e.forEach(function(d){for(var e=1;e<c;e++)e>=b&&lucid.plugin.setProperty(a,d+e,lucid.plugin.getProperty(a,d+(e+1)))});e={};for(var f=1;f<=c;f++)e[f]=f<b?f:f===b?"delete":f-1;lucid.plugin.setProperty(a,"Fields",c-1);lucid.plugin.setProperty(a,"pendingReconnect",[d,e],!0);lucid.plugin.setProperty(a,"selectedRow",null,!0);lucid.text.blurEditor()}}
function M(a){for(var b=lucid.plugin.getProperty(a,"BoundingBox"),c=lucid.plugin.getProperty(a,"Fields"),e=[],d=b.y,f=0;f<=c;f++){var h=I(a,f);e.push({x:b.x,y:d,w:b.w,h:h});d+=h}return e}function N(a,b){return lucid.array.findIndex(M(a),function(a){return lucid.math.Box.pointInBox(b,a)})}function D(){var a=lucid.plugin.getSelectionDetails();return 1===a.length&&lucid.object.contains(n,a[0].className)?a[0].id:null}
function K(a){function b(b,e){var f=lucid.plugin.getProperty(b,e);if(f&&f.Block==a){var h=f.LinkX;f=f.LinkY;for(var k=0,l=0;l<d.length;l++)Math.abs(d[l]-f)<Math.abs(d[k]-f)&&(k=l);(.01>h||.99<h)&&c.push({lineId:b,prop:e,field:k})}}var c=[],e=lucid.plugin.getProperty(a,"Fields"),d=[],f=lucid.plugin.getProperty(a,"linkPoints");if(f)for(var h=0;h<=e;h++)d[h]=f[2*h+2].y;lucid.array.forEach(lucid.plugin.getConnectedLines(a),function(a){b(a,"Endpoint1");b(a,"Endpoint2")});lucid.plugin.setProperty(a,"lastLinesToFieldMap",
c,!0);return c}function J(a,b,c){if(0<b.length){b=b||lucid.plugin.getProperty(a,"lastLinesToFieldMap",!0)||[];c=c||{};var e=lucid.plugin.getProperty(a,"linkPoints"),d=lucid.plugin.getProperty(a,"Fields");b.forEach(function(a){var b=a.lineId,f=a.prop;a=a.field;var l=c[a]||a;a=lucid.plugin.getProperty(b,f);"delete"==l||l>d?(a.LinkX=.5,a.LinkY=0):(l=e[2*l+2].y,a.LinkY!=l&&(a.LinkY=l));lucid.plugin.setPropertyIfChanged(b,f,a)});lucid.plugin.setPropertyIfChanged(a,"lastLinesToFieldMap",null,!0)}}
C(n.ERD_ENTITY_BLOCK,[{name:"Field",align:"left"}]);C(n.ERD_ENTITY_BLOCK_2,[{name:"Key",align:"center"},{name:"Field",align:"left",x:function(a){a=a("Column1");return null!=a?a:60},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}}],{defaultProperties:{Column1:60},sampleProperties:{Column1:.3},onWidthChange:function(a,b){var c={};a=lucid.plugin.getProperty(a,"Column1");null!=a&&a>b-8&&(c.Column1=Math.max(b/2,b-8));return c}});
C(n.ERD_ENTITY_BLOCK_3,[{name:"Field",align:"left"},{name:"Type",align:"left",x:function(a){var b=a("Column1");return null!=b?b:a("BoundingBox").w/2},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}}],{defaultProperties:{Column1:100},onWidthChange:function(a,b){var c={};a=lucid.plugin.getProperty(a,"Column1");null!=a&&a>b-8&&(c.Column1=Math.max(b/2,b-8));return c}});
C(n.ERD_ENTITY_BLOCK_4,[{name:"Key",align:"center"},{name:"Field",align:"left",x:function(a){a=a("Column1");return null!=a?a:60},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}},{name:"Type",align:"left",x:function(a){var b=a("Column2");a=a("BoundingBox").w;return null!=b?a-b:(a-60)/2+60},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column2",lucid.plugin.getProperty(a,"BoundingBox").w-b)}}],{defaultProperties:{Column1:60,Column2:60},sampleProperties:{Column1:.3,
Column2:.35},onWidthChange:function(a,b){var c={},e=lucid.plugin.getProperty(a,"Column1");a=lucid.plugin.getProperty(a,"Column2");null!=e&&e>b-16&&(c.Column1=e=Math.max(b/3,b-16));null!=a&&a>b-e-8&&(c.Column2=Math.max((b-e)/2,b-e-8));return c}});var R={},S={};
R["CFN ERD Zero Or More Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]},{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x+10-30*Math.cos(b),y:a.y-30*Math.sin(b)},{Action:"curve",Control:lucid.math.ellipseArcControlPoints(a.x+
10-30*Math.cos(b)-20,a.y-30*Math.sin(b)-10,20,20)}]}]};S["CFN ERD Zero Or More Arrow"]=40;
R["CFN ERD One Or More Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]},{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b+
Math.atan(.5))},{Action:"line",x:a.x-Math.sqrt(500)*Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-Math.atan(.5))}]}]};S["CFN ERD One Or More Arrow"]=20;R["CFN ERD Many Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]}]};
S["CFN ERD Many Arrow"]=20;
R["CFN ERD Exactly One Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(200)*Math.cos(b+Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b+Math.PI/4)},{Action:"line",x:a.x-Math.sqrt(200)*Math.cos(b-Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b-Math.PI/4)}]},{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*
Math.sin(b+Math.atan(.5))},{Action:"line",x:a.x-Math.sqrt(500)*Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-Math.atan(.5))}]}]};S["CFN ERD Exactly One Arrow"]=20;
R["CFN ERD Zero Or One Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(200)*Math.cos(b+Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b+Math.PI/4)},{Action:"line",x:a.x-Math.sqrt(200)*Math.cos(b-Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b-Math.PI/4)}]},{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x+10-30*Math.cos(b),y:a.y-30*Math.sin(b)},{Action:"curve",
Control:lucid.math.ellipseArcControlPoints(a.x+10-30*Math.cos(b)-20,a.y-30*Math.sin(b)-10,20,20)}]}]};S["CFN ERD Zero Or One Arrow"]=40;R["CFN ERD One Arrow"]=function(a,b,c,e){b=Math.atan2(b.y,b.x);return[{StrokeColor:c,FillColor:"#FFFFFF",LineWidth:e,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b+Math.atan(.5))},{Action:"line",x:a.x-Math.sqrt(500)*Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-Math.atan(.5))}]}]};
S["CFN ERD One Arrow"]=20;lucid.line.addEndpointStyles("erd",R,S);var T=null,V=null,W=null;function X(a,b){for(var c=lucid.plugin.getAllProperties(a),e=c.Fields,d={},f=0;f<b.length;f++){d[b[f]]=[];for(var h=0;h<e;h++){var k=b[f]+(h+1),l=lucid.text.plainText(c[k]);d[b[f]].push({text:l,t:l,s:lucid.text.getStyle(a,k),r:h,o:c[k]})}}V=d.rowCount=e;return d}
function Y(a){for(var b=T.getInput(),c={},e=a.length,d=0,f=0;f<a.length;f++)c[a[f]]=[];for(f=0;f<b.length;f++)0==f%e&&d++,c[a[f%e]].push({text:b[f].value,t:b[f].data.origText,r:b[f].data.origRow,s:b[f].data.styleData,o:b[f].data.origObject});c.rowCount=d;return W=c}
function Z(a,b){for(var c={tag:"ul",classes:"erd-modify-list",sortable:{revert:100,handle:".drag-handle",axis:"y",scroll:!1,update:function(){T.update(Z(Y(b),b))}},children:[]},e=a.rowCount,d=0;d<e;d++){for(var f=[{classes:"drag-handle ui-icon-carat-2-n-s ui-icon"}],h=0;h<b.length;h++)f.push({tag:"input",attr:{type:"text"},value:a[b[h]][d].text,data:{styleData:a[b[h]][d].s||!1,origRow:null!=a[b[h]][d].r?a[b[h]][d].r:d,origText:a[b[h]][d].t,origObject:a[b[h]][d].o}});f.push({classes:"icon silk add",
click:function(a){return function(){var c=Y(b),d=c.rowCount;if(1E3>d){d++;for(var e=0;e<b.length;e++)c[b[e]].splice(a,0,{text:b[e]});c.rowCount=d;T.update(Z(c,b))}}}(d+1)});f.push({classes:"icon silk delete",click:function(a){return function(){var c=Y(b),d=c.rowCount;if(1<d){for(var e=0;e<b.length;e++)c[b[e]].splice(a,1);c.rowCount=d-1;T.update(Z(c,b))}}}(d)});c.children.push({tag:"li",children:f})}return{classes:"erd-modify-container size-"+b.length,children:[c]}}
function p(a){var b=lucid.plugin.getProperty(a,"fieldNames",!0),c=X(a,b);T=lucid.dialog.custom(Z(c,b),{title:lucid.text.plainText(lucid.plugin.getProperty(a,"Name")),closeButton:!0,modal:!0,width:100+207*b.length,buttons:[{label:i18n.get("confirm-ok"),action:function(){var c={},d=K(a),f=Y(b),h=W.rowCount,k=Math.max(h,V);lucid.plugin.getProperty(a,"Font");lucid.plugin.setPropertyIfChanged(a,"Fields",h);for(var l=0;l<b.length;l++)for(var m=0;m<h;m++){var q=f[b[l]][m];c[q.r+1]=m+1;q.text!=q.t?lucid.plugin.setPropertyIfChanged(a,
b[l]+(m+1),lucid.text.styled(q.text,q.s||(m?lucid.text.getStyle(a,b[l]+m):lucid.text.getStyle(a,b[l]+"1")))):q.r!=m&&lucid.plugin.setPropertyIfChanged(a,b[l]+(m+1),q.o)}for(m=0;m<k;m++)c[m+1]||(c[m+1]="delete");lucid.plugin.setProperty(a,"pendingReconnect",[d,c],!0);T.close();T=W=V=null}},{label:i18n.get("confirm-cancel"),action:function(){T.close();T=W=V=null}}]});T.open()}
var r={exportSql:function(a){a=r.loadState(a);a=r.convertToTables(a);a=r.Converter.convertAll(a);lucid.sql.exportSql(a)},loadState:function(a){var b=[],c=[];if(a)b.push(a);else{var e=lucid.plugin.getActivePageId();b=lucid.plugin.getAllBlockIds().filter(function(a){return lucid.string.startsWith(lucid.plugin.getBlockClassName(a),n.ERD_ENTITY_BLOCK)&&lucid.plugin.getItemPageId(a)==e})}for(a=0;a<b.length;a++){var d=r.getBlockName(b[a]),f=r.getBlockColumns(b[a]);c.push({name:d,columns:f})}return c},getBlockName:function(a){a=
lucid.plugin.getProperty(a,"Name");return lucid.text.plainText(a)},getBlockColumns:function(a){var b=lucid.plugin.getAllProperties(a),c=b.Fields;a=lucid.plugin.getProperty(a,"fieldNames",!0);for(var e=[],d=0;d<c;d++){var f={};a.forEach(function(a){var c=lucid.text.plainText(b[a+(d+1)]);f[r.mapFieldName(a)]=c});e.push(f)}return e},mapFieldName:function(a){return"Field"==a?"name":"Type"==a?"type":"Key"==a?"key":a},convertToTables:function(a){return a.map(function(a){return new r.Schema.Table(a.name,
a.columns.map(function(a){return new r.Schema.Column(a.name,a.type,a.restrictNull,a.key)}))})},Schema:{Table:function(a,b){this.name=a;this.columns=b},Column:function(a,b,c,e){this.name=a;this.type=b;this.restrictNull=!!c;this.key=e}},Converter:{}};r.Converter.dbmsList=["mysql","postgresql","sqlserver","oracle"];r.Converter.phrases={mysql:i18n.get("dialog-erdexport-dbms-mysql"),postgresql:i18n.get("dialog-erdexport-dbms-postgresql"),sqlserver:i18n.get("dialog-erdexport-dbms-sqlserver"),oracle:i18n.get("dialog-erdexport-dbms-oracle")};
r.Converter.convertAll=function(a){var b={};r.Converter.dbmsList.map(function(c){b[c]={label:r.Converter.phrases[c],sql:r.Converter.convert(a,c)}});return b};r.Converter.convert=function(a,b){return"oracle"==b?r.Converter.toOracle(a):"postgresql"==b?r.Converter.toPostgreSql(a):"sqlserver"==b?r.Converter.toSqlServer(a):r.Converter.toMySql(a)};
r.Converter.toMySql=function(a){var b="";a.forEach(function(a){var c="CREATE TABLE `";c+=a.name;c+="` (\n";a.columns.forEach(function(a){c+="  `";c+=a.name;c+="`";a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});a=r.Converter.getKeyColumns(a.columns);a.PK&&(c+="  PRIMARY KEY (`"+a.PK.join("`, `")+"`),\n",delete a.PK);for(var d in a)c+="  KEY `"+d+"` (`"+a[d].join("`, `")+"`),\n";c=lucid.string.removeAt(c,c.length-2,1);c+=");\n\n";b+=c});return b};
r.Converter.toPostgreSql=function(a){var b="";a.forEach(function(a){var c='CREATE TABLE "';c+=a.name;c+='" (\n';a.columns.forEach(function(a){c+='  "';c+=a.name;c+='"';a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var d=r.Converter.getKeyColumns(a.columns);d.PK&&(c+='  PRIMARY KEY ("'+d.PK.join('", "')+'"),\n',delete d.PK);c=lucid.string.removeAt(c,c.length-2,1);c+=");\n\n";for(var f in d)c+='CREATE INDEX "'+f+'" ON  "'+a.name+'" ("'+d[f].join('", "')+'");\n\n';
b+=c});return b};
r.Converter.toSqlServer=function(a){var b="";a.forEach(function(a){var c="CREATE TABLE [";c+=a.name;c+="] (\n";a.columns.forEach(function(a){c+="  [";c+=a.name;c+="]";a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var d=r.Converter.getKeyColumns(a.columns);d.PK&&(c+="  PRIMARY KEY (["+d.PK.join("], [")+"]),\n",delete d.PK);c=lucid.string.removeAt(c,c.length-2,1);c+=");\n\n";for(var f in d)c+="CREATE INDEX ["+f+"] ON  ["+a.name+"] (["+d[f].join("], [")+"]);\n\n";
b+=c});return b};
r.Converter.toOracle=function(a){var b="";a.forEach(function(a){var c='CREATE TABLE "';c+=a.name;c+='" (\n';a.columns.forEach(function(a){c+='  "';c+=a.name;c+='"';a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var d=r.Converter.getKeyColumns(a.columns);d.PK&&(c+='  PRIMARY KEY ("'+d.PK.join('", "')+'"),\n',delete d.PK);c=lucid.string.removeAt(c,c.length-2,1);c+=");\n\n";for(var f in d)c+='CREATE INDEX "'+f+'" ON  "'+a.name+'" ("'+d[f].join('", "')+'");\n\n';b+=
c});return b};r.Converter.getKeyColumns=function(a){var b={};a.forEach(function(a){a.key&&(b[a.key]||(b[a.key]=[]),b[a.key].push(a.name))});return b};lucid.plugin.onActivate(function(){u.toolbox.add();lucid.line.enableEndpointStyles("erd")});lucid.plugin.onDeactivate(function(){lucid.line.disableEndpointStyles("erd")});lucid.plugin.createToolGroups({"Entity Relationship":{displayName:i18n.get("plugin-erd-plugin-name"),items:u.toolbox.erdGroups}});
lucid.plugin.createNextBlockGroup([n.ERD_ENTITY_BLOCK,n.ERD_ENTITY_BLOCK_2,n.ERD_ENTITY_BLOCK_3,n.ERD_ENTITY_BLOCK_4]);
//# sourceMappingURL=/js/plugins/v2/source-maps/erd.js.map

};
